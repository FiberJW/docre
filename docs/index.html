
<html>
<head>
<title>Reason code</title>
<script>

</script>
<style>
body {
  padding: 30px;
}
.value-identifier {
    color: #000;
}

.module-identifier {
  color: #aa0;
}

.let-module-identifier,
.constructor-module-identifier,
.switch-module-identifier,
.record-module-identifier,
.field-module-identifier {
  color: #a0a;
}

.let-value-identifier,
.switch-value-identifier,
.record-value-identifier,
.field-value-identifier {
  color: #0aa;
}

.unused-identifier {
  color: #00a;
}

.declaration-var {
  color: #a50000;
}

.string {
    color: #33a20d;
}

.int {
    color: blue;
}

.boolean {
    color: red;
}

.float {
    color: orange;
}

.operator {
  color: #9b9bff;
  font-weight: bold;
}

#main {
    color: #aaa;
    white-space: pre;
    font-family: 'sf mono', monospace;
}
.hovered {
  background-color: #d4ffe2;
}
span {
  display: inline-block;
  position: relative;
}
.id-badge {
  position: absolute;
  top: 100%;
  left: 0;
}
</style>
<pre id="main">open Play_types;

let <span class="declaration-var" data-id="1054">maybeSave</span> = (<span class="declaration-var" data-id="1055">state</span>, <span class="declaration-var" data-id="1056">env</span>) => {
  let <span class="declaration-var" data-id="1057">num</span> = <span class="module-identifier">List</span>.<span class="value-identifier">length</span>(<span class="value-identifier" data-id="1055">state</span>.<span class="field-value-identifier">stones</span>);
  if (<span class="value-identifier" data-id="1055">state</span>.<span class="field-value-identifier">lastSavedHighScore</span> <span class="operator"><</span> <span class="value-identifier" data-id="1057">num</span>) {
    if (<span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">saveUserData</span>(~key=<span class="value-identifier">storageKey</span>, ~value=<span class="value-identifier" data-id="1057">num</span>, <span class="value-identifier" data-id="1056">env</span>)) {
      {...<span class="value-identifier" data-id="1055">state</span>, <span class="record-value-identifier">lastSavedHighScore</span>: <span class="value-identifier" data-id="1057">num</span>}
    } else {
      <span class="value-identifier" data-id="1055">state</span>
    }
  } else {
    <span class="value-identifier" data-id="1055">state</span>
  }
};

let <span class="declaration-var" data-id="1067">maxWalk</span> = <span class="float">5.</span>;
let <span class="declaration-var" data-id="1068">walkSpeed</span> = <span class="float">0.5</span>;

let module MovePlayer = Play_collide.Mover({
  let <span class="declaration-var" data-id="1069">gravity</span> = <span class="float">0.5</span>;
  let <span class="declaration-var" data-id="1070">friction</span> = <span class="float">0.7</span>;
  let <span class="declaration-var" data-id="1071">jump</span> = <span class="float">11.</span>;
  let <span class="declaration-var" data-id="1072">bounce</span> = <span class="boolean">false</span>;
});

let <span class="declaration-var" data-id="1080">isStationaryStoneBelow</span> = (<span class="declaration-var" data-id="1081">stones</span>, <span class="declaration-var" data-id="1082">player</span>) => {
  let <span class="declaration-var" data-id="1083">above</span> = <span class="module-identifier">Geom</span>.<span class="module-identifier">Rect</span>.<span class="value-identifier">push</span>(<span class="value-identifier" data-id="1082">player</span>.<span class="field-value-identifier">box</span>, {<span class="record-module-identifier">Geom</span>.<span class="record-value-identifier">theta</span>: <span class="operator">-.</span><span class="module-identifier">Geom</span>.<span class="value-identifier">halfPi</span>, <span class="record-value-identifier">magnitude</span>: <span class="float">15.</span>});
  let <span class="declaration-var" data-id="1102">below</span> = <span class="module-identifier">Geom</span>.<span class="module-identifier">Rect</span>.<span class="value-identifier">push</span>(<span class="value-identifier" data-id="1082">player</span>.<span class="field-value-identifier">box</span>, {<span class="record-module-identifier">Geom</span>.<span class="record-value-identifier">theta</span>: <span class="module-identifier">Geom</span>.<span class="value-identifier">halfPi</span>, <span class="record-value-identifier">magnitude</span>: <span class="float">0.1</span>});
  <span class="module-identifier">List</span>.<span class="value-identifier">exists</span>(<span class="declaration-var" data-id="1103">stone</span> => {
    <span class="value-identifier">abs_float</span>(<span class="value-identifier" data-id="1103">stone</span>.<span class="field-module-identifier">Stone</span>.<span class="field-value-identifier">vel</span>.<span class="field-value-identifier">magnitude</span>) <span class="operator"><</span> <span class="float">1.</span>
    <span class="operator">&&</span> <span class="value-identifier">!</span><span class="module-identifier">Geom</span>.<span class="module-identifier">Rect</span>.<span class="value-identifier">testCircle</span>(<span class="value-identifier" data-id="1083">above</span>, <span class="value-identifier" data-id="1103">stone</span>.<span class="field-module-identifier">Stone</span>.<span class="field-value-identifier">circle</span>)
    <span class="operator">&&</span> <span class="module-identifier">Geom</span>.<span class="module-identifier">Rect</span>.<span class="value-identifier">testCircle</span>(<span class="value-identifier" data-id="1102">below</span>, <span class="value-identifier" data-id="1103">stone</span>.<span class="field-module-identifier">Stone</span>.<span class="field-value-identifier">circle</span>)
  }, <span class="value-identifier" data-id="1081">stones</span>)
};

let <span class="declaration-var" data-id="1117">movePlayer</span> = (<span class="declaration-var" data-id="1118">userInput</span>, <span class="declaration-var" data-id="1119">player</span>, <span class="declaration-var" data-id="1120">stones</span>, <span class="declaration-var" data-id="1121">blocks</span>, <span class="declaration-var" data-id="1122">timeScale</span>) => {
  let <span class="declaration-var" data-id="1123">vx</span> = <span class="module-identifier">Geom</span>.<span class="value-identifier">vx</span>(<span class="value-identifier" data-id="1119">player</span>.<span class="field-value-identifier">vel</span>);
  let <span class="declaration-var" data-id="1124">acc</span> = <span class="value-identifier" data-id="1118">userInput</span>.<span class="field-value-identifier">left</span> <span class="switch-value-identifier">?</span> (<span class="value-identifier" data-id="1123">vx</span> <span class="operator">></span> <span class="operator">-.</span> <span class="value-identifier" data-id="1067">maxWalk</span> <span class="switch-value-identifier">?</span> Geom.{<span class="record-value-identifier">magnitude</span>: <span class="value-identifier" data-id="1068">walkSpeed</span>, <span class="record-value-identifier">theta</span>: <span class="value-identifier">pi</span>} <span class="switch-value-identifier">:</span> <span class="module-identifier">Geom</span>.<span class="value-identifier">v0</span>) <span class="switch-value-identifier">:</span> (
    <span class="value-identifier" data-id="1118">userInput</span>.<span class="field-value-identifier">right</span> <span class="switch-value-identifier">?</span> (<span class="value-identifier" data-id="1123">vx</span> <span class="operator"><</span> <span class="value-identifier" data-id="1067">maxWalk</span> <span class="switch-value-identifier">?</span> Geom.{<span class="record-value-identifier">magnitude</span>: <span class="value-identifier" data-id="1068">walkSpeed</span>, <span class="record-value-identifier">theta</span>: <span class="float">0.</span>} <span class="switch-value-identifier">:</span> <span class="module-identifier">Geom</span>.<span class="value-identifier">v0</span>) <span class="switch-value-identifier">:</span> <span class="module-identifier">Geom</span>.<span class="value-identifier">v0</span>
  );
  /* let acc = Geom.scaleVector(acc, timeScale); */
  let (<span class="declaration-var" data-id="1195">isOnGround</span>, (<span class="declaration-var" data-id="1196">vel</span>, <span class="declaration-var" data-id="1197">hits</span>)) = <span class="module-identifier">MovePlayer</span>.<span class="value-identifier">moveObject</span>(
    ~reallyCheckJump=<span class="arg-operator">()</span> => {
      <span class="value-identifier" data-id="1080">isStationaryStoneBelow</span>(<span class="value-identifier" data-id="1120">stones</span>, <span class="value-identifier" data-id="1119">player</span>)
    },
    <span class="value-identifier" data-id="1119">player</span>.<span class="field-value-identifier">box</span>.<span class="field-value-identifier">pos</span>, <span class="value-identifier" data-id="1119">player</span>.<span class="field-value-identifier">vel</span>, <span class="value-identifier" data-id="1124">acc</span>, <span class="value-identifier" data-id="1118">userInput</span>.<span class="field-value-identifier">jump</span>, <span class="module-identifier">Play_collide</span>.<span class="value-identifier">testRect</span>(<span class="value-identifier" data-id="1119">player</span>.<span class="field-value-identifier">box</span>), <span class="module-identifier">Play_collide</span>.<span class="value-identifier">collideRect</span>(<span class="value-identifier" data-id="1119">player</span>.<span class="field-value-identifier">box</span>), <span class="value-identifier" data-id="1121">blocks</span>);
  {...<span class="value-identifier" data-id="1119">player</span>, <span class="record-value-identifier" data-id="1196"><span class="value-identifier" data-id="1196">vel</span></span>, <span class="record-value-identifier">box</span>: <span class="module-identifier">Geom</span>.<span class="module-identifier">Rect</span>.<span class="value-identifier">push</span>(<span class="value-identifier" data-id="1119">player</span>.<span class="field-value-identifier">box</span>, <span class="value-identifier" data-id="1196">vel</span>), <span class="record-value-identifier" data-id="1195"><span class="value-identifier" data-id="1195">isOnGround</span></span>}
};

let <span class="declaration-var" data-id="1198">getUserInput</span> = (<span class="declaration-var" data-id="1199">prev</span>, <span class="declaration-var" data-id="1200">env</span>) => Reprocessing.({
  <span class="record-value-identifier">left</span>: <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">Left</span>, <span class="value-identifier" data-id="1200">env</span>) <span class="operator">||</span> <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">A</span>, <span class="value-identifier" data-id="1200">env</span>),
  <span class="record-value-identifier">right</span>: <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">Right</span>, <span class="value-identifier" data-id="1200">env</span>) <span class="operator">||</span> <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">D</span>, <span class="value-identifier" data-id="1200">env</span>),
  <span class="record-value-identifier">up</span>: <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">Up</span>, <span class="value-identifier" data-id="1200">env</span>) <span class="operator">||</span> <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">W</span>, <span class="value-identifier" data-id="1200">env</span>),
  <span class="record-value-identifier">down</span>: <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">Down</span>, <span class="value-identifier" data-id="1200">env</span>) <span class="operator">||</span> <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">S</span>, <span class="value-identifier" data-id="1200">env</span>),
  <span class="record-value-identifier">jump</span>: <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">Up</span>, <span class="value-identifier" data-id="1200">env</span>) <span class="operator">||</span> <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">W</span>, <span class="value-identifier" data-id="1200">env</span>),
  <span class="record-value-identifier">action</span>: <span class="module-identifier">Env</span>.<span class="value-identifier">key</span>(<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">C</span>, <span class="value-identifier" data-id="1200">env</span>),
});

let <span class="declaration-var" data-id="1201">getTouchInput</span> = (<span class="declaration-var" data-id="1202">state</span>, <span class="declaration-var" data-id="1203">env</span>) => {
  let <span class="declaration-var" data-id="1204">throwId</span> = switch <span class="value-identifier" data-id="1202">state</span>.<span class="field-value-identifier">player</span>.<span class="field-value-identifier">throw</span> {
  | <span class="switch-module-identifier">None</span> => <span class="constructor-module-identifier">None</span>
  | <span class="switch-module-identifier">Some</span>((_, _, _, <span class="declaration-var" data-id="1205">id</span>)) => <span class="constructor-module-identifier">Some</span>(<span class="value-identifier" data-id="1205">id</span>)
  };
  <span class="module-identifier">Hashtbl</span>.<span class="value-identifier">fold</span>((<span class="declaration-var" data-id="1244">key</span>, <span class="declaration-var" data-id="1245">pos</span>, <span class="declaration-var" data-id="1246">input</span>) => {
    if (<span class="constructor-module-identifier">Some</span>(<span class="value-identifier" data-id="1244">key</span>) <span class="operator">==</span> <span class="value-identifier" data-id="1204">throwId</span>) {
      <span class="value-identifier" data-id="1246">input</span> /* skip this one */
    } else {
      switch (<span class="module-identifier">Play_touch</span>.<span class="value-identifier">joystickButton</span>(<span class="module-identifier">Geom</span>.<span class="value-identifier">fromTuple</span>(<span class="value-identifier" data-id="1245">pos</span>), <span class="value-identifier" data-id="1203">env</span>)) {
      | <span class="switch-module-identifier">Some</span>(`Left) => {...<span class="value-identifier" data-id="1246">input</span>, <span class="record-value-identifier">left</span>: <span class="boolean">true</span>}
      | <span class="switch-module-identifier">Some</span>(`Right) => {...<span class="value-identifier" data-id="1246">input</span>, <span class="record-value-identifier">right</span>: <span class="boolean">true</span>}
      | <span class="switch-module-identifier">Some</span>(`Jump) => {...<span class="value-identifier" data-id="1246">input</span>, <span class="record-value-identifier">jump</span>: <span class="boolean">true</span>}
      | <span class="switch-module-identifier">Some</span>(`JumpLeft) => {...<span class="value-identifier" data-id="1246">input</span>, <span class="record-value-identifier">jump</span>: <span class="boolean">true</span>, <span class="record-value-identifier">left</span>: <span class="boolean">true</span>}
      | <span class="switch-module-identifier">Some</span>(`JumpRight) => {...<span class="value-identifier" data-id="1246">input</span>, <span class="record-value-identifier">jump</span>: <span class="boolean">true</span>, <span class="record-value-identifier">right</span>: <span class="boolean">true</span>}
      | _ => <span class="value-identifier" data-id="1246">input</span>
      }
    }
  }, <span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">touches</span>(<span class="value-identifier" data-id="1203">env</span>), {
    <span class="record-value-identifier">left</span>: <span class="boolean">false</span>, <span class="record-value-identifier">right</span>: <span class="boolean">false</span>, <span class="record-value-identifier">jump</span>: <span class="boolean">false</span>, <span class="record-value-identifier">action</span>: <span class="boolean">false</span>, <span class="record-value-identifier">up</span>: <span class="boolean">false</span>, <span class="record-value-identifier">down</span>: <span class="boolean">false</span>
  })
};

let <span class="declaration-var" data-id="1247">mergeInputs</span> = (<span class="declaration-var" data-id="1248">one</span>, <span class="declaration-var" data-id="1249">two</span>) => {
  <span class="record-value-identifier">left</span>: <span class="value-identifier" data-id="1248">one</span>.<span class="field-value-identifier">left</span> <span class="operator">||</span> <span class="value-identifier" data-id="1249">two</span>.<span class="field-value-identifier">left</span>,
  <span class="record-value-identifier">right</span>: <span class="value-identifier" data-id="1248">one</span>.<span class="field-value-identifier">right</span> <span class="operator">||</span> <span class="value-identifier" data-id="1249">two</span>.<span class="field-value-identifier">right</span>,
  <span class="record-value-identifier">up</span>: <span class="value-identifier" data-id="1248">one</span>.<span class="field-value-identifier">up</span> <span class="operator">||</span> <span class="value-identifier" data-id="1249">two</span>.<span class="field-value-identifier">up</span>,
  <span class="record-value-identifier">down</span>: <span class="value-identifier" data-id="1248">one</span>.<span class="field-value-identifier">down</span> <span class="operator">||</span> <span class="value-identifier" data-id="1249">two</span>.<span class="field-value-identifier">down</span>,
  <span class="record-value-identifier">jump</span>: <span class="value-identifier" data-id="1248">one</span>.<span class="field-value-identifier">jump</span> <span class="operator">||</span> <span class="value-identifier" data-id="1249">two</span>.<span class="field-value-identifier">jump</span>,
  <span class="record-value-identifier">action</span>: <span class="value-identifier" data-id="1248">one</span>.<span class="field-value-identifier">action</span> <span class="operator">||</span> <span class="value-identifier" data-id="1249">two</span>.<span class="field-value-identifier">action</span>
};

<span class="string">/** TODO I have no idea how to do this right. */</span>
let <span class="declaration-var" data-id="1250">normalFps</span> = <span class="float">1.</span> <span class="operator">/.</span> <span class="float">60.</span>;
let <span class="declaration-var" data-id="1251">getTimeScale</span> = <span class="declaration-var" data-id="1252">env</span> => <span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">deltaTime</span>(<span class="value-identifier" data-id="1252">env</span>) <span class="operator">/.</span> <span class="value-identifier" data-id="1250">normalFps</span>;

let <span class="declaration-var" data-id="1253">handleResize</span> = (<span class="declaration-var" data-id="1254">state</span>, <span class="declaration-var" data-id="1255">env</span>) => {
    let (<span class="declaration-var" data-id="1256">x</span>, <span class="declaration-var" data-id="1257">y</span>, <span class="declaration-var" data-id="1258">w</span>, <span class="declaration-var" data-id="1259">h</span>) = <span class="value-identifier" data-id="1254">state</span>.<span class="field-value-identifier">camera</span>;
    open Reprocessing;
    if (<span class="module-identifier">Env</span>.<span class="value-identifier">width</span>(<span class="value-identifier" data-id="1255">env</span>) <span class="operator">!=</span> <span class="value-identifier">int_of_float</span>(<span class="value-identifier" data-id="1258">w</span>) <span class="operator">||</span> <span class="module-identifier">Env</span>.<span class="value-identifier">height</span>(<span class="value-identifier" data-id="1255">env</span>) <span class="operator">!=</span> <span class="value-identifier">int_of_float</span>(<span class="value-identifier" data-id="1259">h</span>)) {
      {...<span class="value-identifier" data-id="1254">state</span>, <span class="record-value-identifier">camera</span>: (<span class="value-identifier" data-id="1256">x</span>, <span class="value-identifier" data-id="1257">y</span>, <span class="value-identifier">float_of_int</span>(<span class="module-identifier">Env</span>.<span class="value-identifier">width</span>(<span class="value-identifier" data-id="1255">env</span>)), <span class="value-identifier">float_of_int</span>(<span class="module-identifier">Env</span>.<span class="value-identifier">height</span>(<span class="value-identifier" data-id="1255">env</span>)))}
    } else {
      <span class="value-identifier" data-id="1254">state</span>
    }
};

let <span class="declaration-var" data-id="1260">addToInventory</span> = (<span class="declaration-var" data-id="1261">inventory</span>, <span class="declaration-var" data-id="1262">item</span>, <span class="declaration-var" data-id="1263">n</span>) => {
  open Inventory;
  switch (<span class="value-identifier">find</span>(<span class="value-identifier" data-id="1261">inventory</span>.<span class="field-value-identifier">slots</span>, ((<span class="declaration-var" data-id="1266">x</span>, _)) => <span class="value-identifier" data-id="1266">x</span> <span class="operator">==</span> <span class="value-identifier" data-id="1262">item</span>)) {
  | <span class="switch-module-identifier">Some</span>(<span class="declaration-var" data-id="1267">i</span>) => {
    let (_, <span class="declaration-var" data-id="1268">c</span>) = <span class="value-identifier" data-id="1261"><span class="module-identifier">inventory</span>.<span class="field-value-identifier">slot</span>s</span><span class="value-identifier">[<span class="value-identifier" data-id="1267">i</span>]</span>;
    <span class="value-identifier" data-id="1261"><span class="module-identifier">inventory</span>.<span class="field-value-identifier">slots</span>[<span class="value-identifier" data-id="1267">i</span>] = (<span class="value-identifier" data-id="1262">item</span>, <span class="value-identifier" data-id="1268">c</span> </span><span class="operator">+</span><span class="value-identifier"> <span class="value-identifier" data-id="1263">n</span>)</span>
  }
  | <span class="switch-module-identifier">None</span> => {
    switch (<span class="value-identifier">find</span>(<span class="value-identifier" data-id="1261">inventory</span>.<span class="field-value-identifier">slots</span>, ((<span class="declaration-var" data-id="1269">x</span>, _)) => <span class="value-identifier" data-id="1269">x</span> <span class="operator">==</span> <span class="constructor-module-identifier">Inventory</span>.<span class="constructor-module-identifier">Nothing</span>)) {
    | <span class="switch-module-identifier">None</span> => <span class="constructor-operator">()</span>
    | <span class="switch-module-identifier">Some</span>(<span class="declaration-var" data-id="1270">i</span>) => {
      <span class="value-identifier" data-id="1261"><span class="module-identifier">inventory</span>.<span class="field-value-identifier">slots</span>[<span class="value-identifier" data-id="1270">i</span>] = (<span class="value-identifier" data-id="1262">item</span></span>,<span class="value-identifier"> <span class="value-identifier" data-id="1263">n</span>)</span>
    }
    }
  }
  }
};

let <span class="declaration-var" data-id="1271">positionsToDig</span> = (<span class="declaration-var" data-id="1272">player</span>, <span class="declaration-var" data-id="1273">userInput</span>, <span class="declaration-var" data-id="1274">facingLeft</span>) => {
  let <span class="declaration-var" data-id="1275">pos</span> = <span class="value-identifier" data-id="1272">player</span>.<span class="field-value-identifier">box</span>.<span class="field-module-identifier">Geom</span>.<span class="field-module-identifier">Rect</span>.<span class="field-value-identifier">pos</span>;
  if (<span class="value-identifier" data-id="1273">userInput</span>.<span class="field-value-identifier">up</span>) {
    [<span class="constructor-operator"><span class="constructor-operator">(<span class="int">0</span>, <span class="int">-1</span>),
      <span class="constructor-operator">(<span class="value-identifier">mod_float</span>(<span class="value-identifier" data-id="1275">pos</span>.<span class="field-module-identifier">Geom</span>.<span class="field-value-identifier">x</span> <span class="operator">/.</span> <span class="value-identifier">blockSize</span>, <span class="float">1.</span>) <span class="operator">></span> <span class="float">0.5</span> <span class="switch-value-identifier">?</span> <span class="int">1</span> <span class="switch-value-identifier">:</span> <span class="int">-1</span>, <span class="int">-1</span>),</span></span></span>
    ]
  } else if (<span class="value-identifier" data-id="1273">userInput</span>.<span class="field-value-identifier">left</span>) {
    <span class="value-identifier" data-id="1273">userInput</span>.<span class="field-value-identifier">down</span> <span class="switch-value-identifier">?</span> [<span class="constructor-operator"><span class="constructor-operator">(<span class="int">-1</span>, <span class="int">0</span>)</span></span>] <span class="switch-value-identifier">:</span> [<span class="constructor-operator"><span class="constructor-operator">(<span class="int">-1</span>, <span class="int">-1</span>), <span class="constructor-operator">(<span class="int">-1</span>, <span class="int">0</span>)</span></span></span>]
  } else if (<span class="value-identifier" data-id="1273">userInput</span>.<span class="field-value-identifier">right</span>) {
    <span class="value-identifier" data-id="1273">userInput</span>.<span class="field-value-identifier">down</span> <span class="switch-value-identifier">?</span> [<span class="constructor-operator"><span class="constructor-operator">(<span class="int">1</span>, <span class="int">0</span>)</span></span>] <span class="switch-value-identifier">:</span> [<span class="constructor-operator"><span class="constructor-operator">(<span class="int">1</span>, <span class="int">-1</span>), <span class="constructor-operator">(<span class="int">1</span>, <span class="int">0</span>)</span></span></span>]
  } else if (<span class="value-identifier" data-id="1273">userInput</span>.<span class="field-value-identifier">down</span>) {
    [
      <span class="constructor-operator"><span class="constructor-operator">(<span class="int">0</span>, <span class="int">1</span>),
      <span class="constructor-operator">(<span class="value-identifier">mod_float</span>(<span class="value-identifier" data-id="1275">pos</span>.<span class="field-module-identifier">Geom</span>.<span class="field-value-identifier">x</span> <span class="operator">/.</span> <span class="value-identifier">blockSize</span>, <span class="float">1.</span>) <span class="operator">></span> <span class="float">0.5</span> <span class="switch-value-identifier">?</span> <span class="int">1</span> <span class="switch-value-identifier">:</span> <span class="int">-1</span>, <span class="int">1</span>),</span></span></span>
    ];
  } else {
    [<span class="constructor-operator"><span class="constructor-operator">(<span class="value-identifier" data-id="1274">facingLeft</span> <span class="switch-value-identifier">?</span> <span class="int">-1</span> <span class="switch-value-identifier">:</span> <span class="int">1</span>, <span class="int">-1</span>), <span class="constructor-operator">(<span class="value-identifier" data-id="1274">facingLeft</span> <span class="switch-value-identifier">?</span> <span class="int">-1</span> <span class="switch-value-identifier">:</span> <span class="int">1</span>, <span class="int">0</span>)</span></span></span>]
  };

};

let <span class="declaration-var" data-id="1276">attack</span> = (<span class="declaration-var" data-id="1277">state</span>, <span class="declaration-var" data-id="1278">player</span>, <span class="declaration-var" data-id="1279">block</span>, <span class="declaration-var" data-id="1280">x</span>, <span class="declaration-var" data-id="1281">y</span>) => {
  open Block;
  let <span class="declaration-var" data-id="1285">x</span> = <span class="value-identifier">loopx</span>(<span class="value-identifier" data-id="1277">state</span>.<span class="field-value-identifier">blocks</span>, <span class="value-identifier" data-id="1280">x</span>);
  let <span class="declaration-var" data-id="1286">damage</span> = <span class="float">0.35</span>;
  <span class="value-identifier" data-id="1277"><span class="module-identifier"><span class="module-identifier">state</span>.<span class="field-value-identifier">block</span>s</span><span class="value-identifier">[<span class="value-identifier" data-id="1281">y</span>]</span>[<span class="value-identifier" data-id="1285">x</span>] =
  if (<span class="value-identifier" data-id="1279">block</span>.<span class="field-value-identifier">damage</span> <span class="operator">+.</span> <span class="value-identifier" data-id="1286">damage</span> <span class="operator">>=</span> <span class="float">1.</span>) {
    if (<span class="value-identifier" data-id="1279">block</span>.<span class="field-module-identifier">Block</span>.<span class="field-value-identifier">kind</span> <span class="operator">===</span> <span class="constructor-module-identifier">Block</span>.<span class="constructor-module-identifier">Rock</span>) {
      <span class="value-identifier" data-id="1260">addToInventory</span>(<span class="value-identifier" data-id="1278">player</span>.<span class="field-value-identifier">inventory</span>, <span class="constructor-module-identifier">Inventory</span>.<span class="constructor-module-identifier">Stone</span>, <span class="int">2</span> <span class="operator">+</span> <span class="module-identifier">Random</span>.<span class="value-identifier">int</span>(<span class="int">3</span>))
    };
    <span class="constructor-module-identifier">None</span>
  } else {
    <span class="constructor-module-identifier">Some</span>({
      ...<span class="value-identifier" data-id="1279">block</span>,
      <span class="record-value-identifier">damage</span>: <span class="value-identifier" data-id="1279">block</span>.<span class="field-value-identifier">damage</span> <span class="operator">+.</span> <span class="value-identifier" data-id="1286">damage</span>
    })</span>
<span class="value-identifier">  }</span>
};

let <span class="declaration-var" data-id="1287">dig</span> = (<span class="declaration-var" data-id="1288">state</span>, <span class="declaration-var" data-id="1289">player</span>, <span class="declaration-var" data-id="1290">userInput</span>, <span class="declaration-var" data-id="1291">facingLeft</span>, <span class="declaration-var" data-id="1292">env</span>) => {
  if (<span class="value-identifier">!</span><span class="value-identifier" data-id="1290">userInput</span>.<span class="field-value-identifier">action</span> <span class="operator">||</span> <span class="value-identifier" data-id="1289">player</span>.<span class="field-value-identifier">throw</span> <span class="operator">!==</span> <span class="constructor-module-identifier">None</span>) {
    <span class="value-identifier" data-id="1289">player</span>
  } else {
    let (<span class="declaration-var" data-id="1293">actionTimer</span>, <span class="declaration-var" data-id="1294">looped</span>) = <span class="module-identifier">Timer</span>.<span class="value-identifier">incLoop</span>(<span class="value-identifier" data-id="1289">player</span>.<span class="field-value-identifier">actionTimer</span>, <span class="value-identifier" data-id="1292">env</span>);
    if (<span class="value-identifier" data-id="1294">looped</span>) {
      let <span class="declaration-var" data-id="1295">pos</span> = <span class="value-identifier" data-id="1289">player</span>.<span class="field-value-identifier">box</span>.<span class="field-module-identifier">Geom</span>.<span class="field-module-identifier">Rect</span>.<span class="field-value-identifier">pos</span>;
      let (<span class="declaration-var" data-id="1296">x</span>, <span class="declaration-var" data-id="1297">y</span>) = <span class="value-identifier">blockPos</span>(<span class="value-identifier" data-id="1295">pos</span>);
      <span class="string">/** So far we only strike down */</span>
      let <span class="declaration-var" data-id="1298">positionsToCheck</span> = <span class="value-identifier" data-id="1271">positionsToDig</span>(<span class="value-identifier" data-id="1289">player</span>, <span class="value-identifier" data-id="1290">userInput</span>, <span class="value-identifier" data-id="1291">facingLeft</span>);
      let <span class="declaration-var" data-id="1299">attack</span> = <span class="value-identifier" data-id="1276">attack</span>(<span class="value-identifier" data-id="1288">state</span>, <span class="value-identifier" data-id="1289">player</span>);
      let rec <span class="declaration-var" data-id="1300">loop</span> = (<span class="declaration-var" data-id="1301">positions</span>) => switch <span class="value-identifier" data-id="1301">positions</span> {
      | <span class="switch-operator">[]</span> => <span class="constructor-operator">()</span>
      | [<span class="switch-operator">(<span class="declaration-var" data-id="1302">dx</span>, <span class="declaration-var" data-id="1303">dy</span>), ...<span class="declaration-var" data-id="1304">rest</span></span>] => switch (<span class="value-identifier">getBlock</span>(<span class="value-identifier" data-id="1288">state</span>.<span class="field-value-identifier">blocks</span>, (<span class="value-identifier" data-id="1296">x</span> <span class="operator">+</span> <span class="value-identifier" data-id="1302">dx</span>, <span class="value-identifier" data-id="1297">y</span> <span class="operator">+</span> <span class="value-identifier" data-id="1303">dy</span>))) {
      | <span class="switch-module-identifier">None</span> => <span class="value-identifier" data-id="1300">loop</span>(<span class="value-identifier" data-id="1304">rest</span>)
      | <span class="switch-module-identifier">Some</span>(<span class="declaration-var" data-id="1305">block</span>) => <span class="value-identifier" data-id="1299">attack</span>(<span class="value-identifier" data-id="1305">block</span>, <span class="value-identifier" data-id="1296">x</span> <span class="operator">+</span> <span class="value-identifier" data-id="1302">dx</span>, <span class="value-identifier" data-id="1297">y</span> <span class="operator">+</span> <span class="value-identifier" data-id="1303">dy</span>)
      }
      };
      <span class="value-identifier" data-id="1300">loop</span>(<span class="value-identifier" data-id="1298">positionsToCheck</span>)
    };
    {...<span class="value-identifier" data-id="1289">player</span>, <span class="record-value-identifier" data-id="1293"><span class="value-identifier" data-id="1293">actionTimer</span></span>}
  }
};

let <span class="declaration-var" data-id="1306">collideStonesWithPlayer</span> = (<span class="declaration-var" data-id="1307">stones</span>, <span class="declaration-var" data-id="1308">player</span>) => {
  <span class="module-identifier">List</span>.<span class="value-identifier">fold_left</span>(
    ((<span class="declaration-var" data-id="1309">stones</span>, <span class="declaration-var" data-id="1310">player</span>), <span class="declaration-var" data-id="1311">stone</span>) => {
      if (<span class="module-identifier">Geom</span>.<span class="module-identifier">Rect</span>.<span class="value-identifier">testCircle</span>(<span class="value-identifier" data-id="1310">player</span>.<span class="field-value-identifier">box</span>, <span class="value-identifier" data-id="1311">stone</span>.<span class="field-module-identifier">Stone</span>.<span class="field-value-identifier">circle</span>)) {
        if (<span class="value-identifier" data-id="1311">stone</span>.<span class="field-value-identifier">live</span>) {
          let <span class="declaration-var" data-id="1312">vel</span> = <span class="module-identifier">Geom</span>.<span class="value-identifier">addVectors</span>(<span class="value-identifier" data-id="1311">stone</span>.<span class="field-module-identifier">Stone</span>.<span class="field-value-identifier">vel</span>, <span class="module-identifier">Geom</span>.<span class="value-identifier">invertVector</span>(<span class="value-identifier" data-id="1310">player</span>.<span class="field-value-identifier">vel</span>));

          /* let v = Geom.Aabb.collideToCircle(vel, Geom.Rect.aabb(player.box), stone.Stone.circle); */

          let <span class="declaration-var" data-id="1313">v</span> = <span class="module-identifier">Geom</span>.<span class="module-identifier">Aabb</span>.<span class="value-identifier">vectorToCircle</span>(<span class="module-identifier">Geom</span>.<span class="module-identifier">Rect</span>.<span class="value-identifier">aabb</span>(<span class="module-identifier">Geom</span>.<span class="module-identifier">Rect</span>.<span class="value-identifier">push</span>( <span class="value-identifier" data-id="1310">player</span>.<span class="field-value-identifier">box</span>, <span class="value-identifier" data-id="1310">player</span>.<span class="field-value-identifier">vel</span>)), <span class="value-identifier" data-id="1311">stone</span>.<span class="field-module-identifier">Stone</span>.<span class="field-value-identifier">circle</span>);
          let <span class="declaration-var" data-id="1328">playerRad</span> = <span class="float">20.</span>;

          let <span class="declaration-var" data-id="1329">v</span> = <span class="value-identifier" data-id="1313">v</span> <span class="operator">|></span> <span class="module-identifier">Geom</span>.<span class="value-identifier">invertVector</span>;
          let <span class="declaration-var" data-id="1330">first</span> = <span class="float">400.</span>;
          let <span class="declaration-var" data-id="1331">second</span> = (<span class="value-identifier" data-id="1311">stone</span>.<span class="field-module-identifier">Stone</span>.<span class="field-value-identifier">circle</span>.<span class="field-value-identifier">rad</span> <span class="operator">*.</span> <span class="value-identifier" data-id="1311">stone</span>.<span class="field-module-identifier">Stone</span>.<span class="field-value-identifier">circle</span>.<span class="field-value-identifier">rad</span>);
          let <span class="declaration-var" data-id="1332">fshare</span> = <span class="value-identifier" data-id="1330">first</span> <span class="operator">/.</span> (<span class="value-identifier" data-id="1330">first</span> <span class="operator">+.</span> <span class="value-identifier" data-id="1331">second</span>);

          let <span class="declaration-var" data-id="1333">stone</span> = <span class="module-identifier">Stone</span>.<span class="value-identifier">force</span>(<span class="value-identifier" data-id="1311">stone</span>, <span class="value-identifier" data-id="1329">v</span> <span class="operator">|></span> <span class="module-identifier">Geom</span>.<span class="value-identifier">invertVector</span> <span class="operator">|></span> <span class="declaration-var" data-id="1334">x</span> => <span class="module-identifier">Geom</span>.<span class="value-identifier">scaleVector</span>(<span class="value-identifier" data-id="1334">x</span>, <span class="float">1.</span> <span class="operator">-.</span> <span class="value-identifier" data-id="1332">fshare</span>));
          let <span class="declaration-var" data-id="1335">player</span> = <span class="module-identifier">Player</span>.<span class="value-identifier">force</span>(<span class="value-identifier" data-id="1310">player</span>, <span class="module-identifier">Geom</span>.<span class="value-identifier">scaleVector</span>(<span class="value-identifier" data-id="1329">v</span>, <span class="value-identifier" data-id="1332">fshare</span>));

          /* oneRef := (Stone.force(one, v |> Geom.invertVector |> x => Geom.scaleVector(x, 1. -. fshare)), mone, true, ai);
          otherRef := (Stone.force(other, Geom.scaleVector(v, fshare)), mother, true, bi); */

          ([<span class="value-identifier" data-id="1333"><span class="constructor-operator">stone</span>, ...<span class="value-identifier" data-id="1309">stones</span></span>], <span class="value-identifier" data-id="1335">player</span>)
        } else {
          ([<span class="value-identifier" data-id="1311"><span class="constructor-operator">stone</span>, ...<span class="value-identifier" data-id="1309">stones</span></span>], <span class="value-identifier" data-id="1310">player</span>)
        }
      } else {
        ([<span class="value-identifier" data-id="1311"><span class="constructor-operator">stone</span>.<span class="field-value-identifier">live</span> <span class="switch-value-identifier">?</span> <span class="value-identifier" data-id="1311">stone</span> <span class="switch-value-identifier">:</span> {...<span class="value-identifier" data-id="1311">stone</span>, <span class="record-value-identifier">live</span>: <span class="boolean">true</span>}, ...<span class="value-identifier" data-id="1309">stones</span></span>], <span class="value-identifier" data-id="1310">player</span>)
      }
    },
    (<span class="constructor-operator">[]</span>, <span class="value-identifier" data-id="1308">player</span>),
    <span class="value-identifier" data-id="1307">stones</span>
  )
};

let <span class="declaration-var" data-id="1336">step</span> = (<span class="declaration-var" data-id="1337">state</span>, <span class="declaration-var" data-id="1338">context</span>, <span class="declaration-var" data-id="1339">env</span>) => {
  /* Handle resize */
  let <span class="declaration-var" data-id="1340">state</span> = <span class="value-identifier" data-id="1253">handleResize</span>(<span class="value-identifier" data-id="1337">state</span>, <span class="value-identifier" data-id="1339">env</span>);

  let <span class="declaration-var" data-id="1341">timeScale</span> = <span class="value-identifier" data-id="1251">getTimeScale</span>(<span class="value-identifier" data-id="1339">env</span>);
  let <span class="declaration-var" data-id="1342">userInput</span> = <span class="value-identifier" data-id="1198">getUserInput</span>(<span class="value-identifier" data-id="1340">state</span>.<span class="field-value-identifier">userInput</span>, <span class="value-identifier" data-id="1339">env</span>);
  let <span class="declaration-var" data-id="1343">userInput</span> = if (<span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">isTouchScreen</span>(<span class="value-identifier" data-id="1339">env</span>)) {
    <span class="value-identifier" data-id="1247">mergeInputs</span>(<span class="value-identifier" data-id="1342">userInput</span>, <span class="value-identifier" data-id="1201">getTouchInput</span>(<span class="value-identifier" data-id="1340">state</span>, <span class="value-identifier" data-id="1339">env</span>));
  } else {
    <span class="value-identifier" data-id="1342">userInput</span>
  };

  let <span class="declaration-var" data-id="1344">player</span> = <span class="value-identifier" data-id="1340">state</span>.<span class="field-value-identifier">player</span>;
  let <span class="declaration-var" data-id="1345">stones</span> = <span class="module-identifier">Play_stones</span>.<span class="value-identifier">collideStones</span>(<span class="value-identifier" data-id="1340">state</span>.<span class="field-value-identifier">stones</span>);
  let (<span class="declaration-var" data-id="1346">stones</span>, <span class="declaration-var" data-id="1347">player</span>) = <span class="value-identifier" data-id="1306">collideStonesWithPlayer</span>(<span class="value-identifier" data-id="1345">stones</span>, <span class="value-identifier" data-id="1344">player</span>);
  let <span class="declaration-var" data-id="1348">stones</span> = <span class="module-identifier">Play_stones</span>.<span class="value-identifier">moveStones</span>(<span class="value-identifier" data-id="1346">stones</span>, <span class="value-identifier" data-id="1340">state</span>.<span class="field-value-identifier">blocks</span>);

  let <span class="declaration-var" data-id="1349">player</span> = <span class="value-identifier" data-id="1117">movePlayer</span>(<span class="value-identifier" data-id="1343">userInput</span>, <span class="value-identifier" data-id="1347">player</span>, <span class="value-identifier" data-id="1348">stones</span>, <span class="value-identifier" data-id="1340">state</span>.<span class="field-value-identifier">blocks</span>, <span class="value-identifier" data-id="1341">timeScale</span>);
  let <span class="declaration-var" data-id="1350">inputLeft</span> = <span class="value-identifier" data-id="1343">userInput</span>.<span class="field-value-identifier">left</span> <span class="switch-value-identifier">?</span> <span class="boolean">true</span> <span class="switch-value-identifier">:</span> (<span class="value-identifier" data-id="1343">userInput</span>.<span class="field-value-identifier">right</span> <span class="switch-value-identifier">?</span> <span class="boolean">false</span> <span class="switch-value-identifier">:</span> <span class="value-identifier" data-id="1349">player</span>.<span class="field-value-identifier">facingLeft</span>);
  let <span class="declaration-var" data-id="1351">facingLeft</span> = switch <span class="value-identifier" data-id="1349">player</span>.<span class="field-value-identifier">throw</span> {
  | <span class="switch-module-identifier">None</span> => <span class="value-identifier" data-id="1350">inputLeft</span>
  | <span class="switch-module-identifier">Some</span>((_, <span class="declaration-var" data-id="1352">v</span>, _, _)) => <span class="value-identifier" data-id="1352">v</span>.<span class="field-module-identifier">Geom</span>.<span class="field-value-identifier">magnitude</span> <span class="operator">></span> <span class="float">5.</span> <span class="switch-value-identifier">?</span> <span class="module-identifier">Geom</span>.<span class="value-identifier">vx</span>(<span class="value-identifier" data-id="1352">v</span>) <span class="operator"><</span> <span class="float">0.</span> <span class="switch-value-identifier">:</span> <span class="value-identifier" data-id="1350">inputLeft</span>
  };
  let <span class="declaration-var" data-id="1353">walkTimer</span> = (<span class="value-identifier" data-id="1343">userInput</span>.<span class="field-value-identifier">left</span> <span class="operator">||</span> <span class="value-identifier" data-id="1343">userInput</span>.<span class="field-value-identifier">right</span> <span class="switch-value-identifier">?</span> <span class="value-identifier" data-id="1349">player</span>.<span class="field-value-identifier">walkTimer</span> <span class="operator">+.</span> <span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">deltaTime</span>(<span class="value-identifier" data-id="1339">env</span>) <span class="switch-value-identifier">:</span> <span class="float">0.</span>);
  let (<span class="declaration-var" data-id="1354">camera</span>, <span class="declaration-var" data-id="1355">player</span>) = <span class="module-identifier">Play_camera</span>.<span class="value-identifier">followPlayer</span>(<span class="value-identifier" data-id="1349">player</span>, <span class="value-identifier" data-id="1340">state</span>.<span class="field-value-identifier">camera</span>, <span class="value-identifier">gameWidth</span>);
  let <span class="declaration-var" data-id="1356">player</span> = if (<span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">keyPressed</span>(<span class="constructor-module-identifier">Reprocessing</span>.<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">Space</span>, <span class="value-identifier" data-id="1339">env</span>)) {
    <span class="module-identifier">Play_touch</span>.<span class="value-identifier">switchSkin</span>(<span class="value-identifier" data-id="1355">player</span>)
  } else {
    <span class="value-identifier" data-id="1355">player</span>
  };
  let <span class="declaration-var" data-id="1357">player</span> = {...<span class="value-identifier" data-id="1356">player</span>, <span class="record-value-identifier" data-id="1351"><span class="value-identifier" data-id="1351">facingLeft</span></span>, <span class="record-value-identifier" data-id="1353"><span class="value-identifier" data-id="1353">walkTimer</span></span>};

  let <span class="declaration-var" data-id="1358">player</span> = <span class="value-identifier" data-id="1287">dig</span>(<span class="value-identifier" data-id="1340">state</span>, <span class="value-identifier" data-id="1357">player</span>, <span class="value-identifier" data-id="1343">userInput</span>, <span class="value-identifier" data-id="1351">facingLeft</span>, <span class="value-identifier" data-id="1339">env</span>);

  let <span class="declaration-var" data-id="1359">state</span> = if (<span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">frameCount</span>(<span class="value-identifier" data-id="1339">env</span>) <span class="value-identifier">mod</span> <span class="int">100</span> <span class="operator">==</span> <span class="int">0</span>) {
    <span class="value-identifier" data-id="1054">maybeSave</span>(<span class="value-identifier" data-id="1340">state</span>, <span class="value-identifier" data-id="1339">env</span>)
  } else {
    <span class="value-identifier" data-id="1340">state</span>
  };

  {
    ...<span class="value-identifier" data-id="1359">state</span>,
    <span class="record-value-identifier" data-id="1343"><span class="value-identifier" data-id="1343">userInput</span></span>,
    <span class="record-value-identifier" data-id="1348"><span class="value-identifier" data-id="1348">stones</span></span>,
    <span class="record-value-identifier" data-id="1354"><span class="value-identifier" data-id="1354">camera</span></span>,
    <span class="record-value-identifier" data-id="1358"><span class="value-identifier" data-id="1358">player</span></span>
  }
};

let <span class="declaration-var" data-id="1360">fillWithRocks</span> = (<span class="declaration-var" data-id="1361">state</span>, <span class="declaration-var" data-id="1362">env</span>) => {
  <span class="module-identifier">GeomDebug</span>.<span class="value-identifier">range</span>(<span class="int">100</span>) <span class="operator">|></span> <span class="module-identifier">List</span>.<span class="value-identifier">fold_left</span>((<span class="declaration-var" data-id="1363">state</span>, <span class="declaration-var" data-id="1364">i</span>) => {
    {...<span class="value-identifier" data-id="1363">state</span>, <span class="record-value-identifier">stones</span>: [
      <span class="constructor-operator">{
        <span class="record-module-identifier">Play_types</span>.<span class="record-module-identifier">Stone</span>.<span class="record-value-identifier">circle</span>: {
          <span class="record-value-identifier">center</span>: {
            <span class="record-module-identifier">Geom</span>.<span class="record-value-identifier">x</span>: <span class="module-identifier">Random</span>.<span class="value-identifier">float</span>(<span class="value-identifier">float_of_int</span>(<span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">width</span>(<span class="value-identifier" data-id="1362">env</span>)) <span class="operator">*.</span> <span class="float">0.8</span>),
            <span class="record-value-identifier">y</span>: <span class="float">-300.</span> <span class="operator">+.</span> <span class="module-identifier">Random</span>.<span class="value-identifier">float</span>(<span class="float">100.</span>),
          },
          <span class="record-value-identifier">rad</span>: <span class="module-identifier">Random</span>.<span class="value-identifier">float</span>(<span class="float">10.</span>) <span class="operator">+.</span> <span class="float">10.</span>,
        },
        <span class="record-value-identifier">vel</span>: <span class="module-identifier">Geom</span>.<span class="value-identifier">v0</span>,
        <span class="record-value-identifier">rotation</span>: <span class="module-identifier">Random</span>.<span class="value-identifier">float</span>(<span class="module-identifier">Geom</span>.<span class="value-identifier">pi</span>),
        <span class="record-value-identifier">live</span>: <span class="boolean">true</span>,
      },
      ...<span class="value-identifier" data-id="1363">state</span>.<span class="field-value-identifier">stones</span></span>
    ]}
  }, <span class="value-identifier" data-id="1361">state</span>)
};

let <span class="declaration-var" data-id="1365">stepDebug</span> = (<span class="declaration-var" data-id="1366">state</span>, <span class="declaration-var" data-id="1367">context</span>, <span class="declaration-var" data-id="1368">env</span>) => {
  let <span class="declaration-var" data-id="1369">state</span> = <span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">keyPressed</span>(<span class="constructor-module-identifier">Reprocessing</span>.<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">Z</span>, <span class="value-identifier" data-id="1368">env</span>)
    <span class="switch-value-identifier">?</span> {...<span class="value-identifier" data-id="1366">state</span>, <span class="record-value-identifier">zoom</span>: <span class="value-identifier">!</span><span class="value-identifier" data-id="1366">state</span>.<span class="field-value-identifier">zoom</span>}
    <span class="switch-value-identifier">:</span> <span class="value-identifier" data-id="1366">state</span>;
  if (<span class="value-identifier" data-id="1369">state</span>.<span class="field-value-identifier">paused</span>) {
    <span class="value-identifier" data-id="1369">state</span>
  } else if (<span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">keyPressed</span>(<span class="constructor-module-identifier">Reprocessing</span>.<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">Q</span>, <span class="value-identifier" data-id="1368">env</span>)) {
    <span class="value-identifier" data-id="1360">fillWithRocks</span>(<span class="value-identifier" data-id="1369">state</span>, <span class="value-identifier" data-id="1368">env</span>)
  } else if (<span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">keyPressed</span>(<span class="constructor-module-identifier">Reprocessing</span>.<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">F</span>, <span class="value-identifier" data-id="1368">env</span>)) {
    {...<span class="value-identifier" data-id="1336">step</span>(<span class="value-identifier" data-id="1369">state</span>, <span class="value-identifier" data-id="1367">context</span>, <span class="value-identifier" data-id="1368">env</span>), <span class="record-value-identifier">frameByFrame</span>: <span class="boolean">true</span>}
  } else if (<span class="value-identifier" data-id="1369">state</span>.<span class="field-value-identifier">frameByFrame</span>) {
    if (<span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">keyPressed</span>(<span class="constructor-module-identifier">Reprocessing</span>.<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">P</span>, <span class="value-identifier" data-id="1368">env</span>)) {
      {...<span class="value-identifier" data-id="1369">state</span>, <span class="record-value-identifier">frameByFrame</span>: <span class="boolean">false</span>}
    } else if (<span class="module-identifier">Reprocessing</span>.<span class="module-identifier">Env</span>.<span class="value-identifier">keyPressed</span>(<span class="constructor-module-identifier">Reprocessing</span>.<span class="constructor-module-identifier">Events</span>.<span class="constructor-module-identifier">H</span>, <span class="value-identifier" data-id="1368">env</span>)) {
      {...<span class="value-identifier" data-id="1369">state</span>, <span class="record-value-identifier">hitByHit</span>: switch <span class="value-identifier" data-id="1369">state</span>.<span class="field-value-identifier">hitByHit</span> {
      | <span class="switch-module-identifier">Some</span>(<span class="declaration-var" data-id="1370">x</span>) => <span class="constructor-module-identifier">Some</span>(<span class="value-identifier" data-id="1370">x</span> <span class="operator">+</span> <span class="int">1</span>)
      | <span class="switch-module-identifier">None</span> => <span class="constructor-module-identifier">Some</span>(<span class="int">0</span>)
      }}
    } else {
      <span class="value-identifier" data-id="1369">state</span>
    }
  } else {
    <span class="value-identifier" data-id="1336">step</span>(<span class="value-identifier" data-id="1369">state</span>, <span class="value-identifier" data-id="1367">context</span>, <span class="value-identifier" data-id="1368">env</span>);
  }
};

let <span class="declaration-var" data-id="1371">backPressed</span> = (<span class="declaration-var" data-id="1372">state</span>, <span class="declaration-var" data-id="1373">context</span>, <span class="declaration-var" data-id="1374">env</span>) => {
  if (<span class="value-identifier" data-id="1372">state</span>.<span class="field-value-identifier">paused</span>) {
    <span class="constructor-module-identifier">None</span>
  } else {
    <span class="constructor-module-identifier">Some</span>({...<span class="value-identifier" data-id="1372">state</span>, <span class="record-value-identifier">paused</span>: <span class="boolean">true</span>})
  }
};</pre>
<script>

  document.getElementById('main').addEventListener('mouseover', evt => {
    const id = evt.target.getAttribute('data-id')
    if (id) {
      [].map.call(document.querySelectorAll('[data-id="' + id + '"]'), el => {
        el.classList.add('hovered')
      })
    }
  })

  document.getElementById('main').addEventListener('mouseout', evt => {
    const id = evt.target.getAttribute('data-id')
    if (id) {
      [].map.call(document.querySelectorAll('[data-id="' + id + '"]'), el => {
        el.classList.remove('hovered')
      })
    }
  })

</script>
